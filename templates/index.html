<!doctype html><html lang=en>
<head><meta charset=utf-8><title>Internet Connection Monitor</title>
<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
<script src='https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3'></script>
<style>
  body{font-family:sans-serif;margin:2rem}
  #status{font-size:1.2rem;margin-bottom:1rem}
  .chart-container{margin-bottom:2rem}
  .chart-title{font-size:1.1rem;font-weight:bold;margin-bottom:0.5rem}
  .legend{background:#f5f5f5;padding:1rem;border-radius:8px;margin-bottom:2rem}
  .legend-item{display:inline-block;margin-right:2rem;margin-bottom:0.5rem}
  .legend-color{display:inline-block;width:20px;height:15px;margin-right:8px;vertical-align:middle;border-radius:3px}
</style></head>

<body>
  <h1>Internet Connection Monitor</h1>
  <p id=status>Startingâ€¦</p>
  
  <div class="legend">
    <strong>Availability Levels:</strong><br>
    <div class="legend-item"><span class="legend-color" style="background:#4ade80"></span>Excellent (â‰¥99.9%)</div>
    <div class="legend-item"><span class="legend-color" style="background:#eab308"></span>Good (98.0-99.8%)</div>
    <div class="legend-item"><span class="legend-color" style="background:#ef4444"></span>Problematic (<98%)</div>
    <div class="legend-item"><span class="legend-color" style="background:#3b82f6"></span>No Data</div>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">Detailed Timeline</div>
    <canvas id=c height=80></canvas>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">24-Hour Overview (last 24h)</div>
    <canvas id=hourlyChart height=60></canvas>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">Daily Overview (last 30 days)</div>
    <canvas id=dailyChart height=60></canvas>
  </div>

<script>
let chart=null, hourlyChart=null, dailyChart=null;

// Helper: convert UTC timestamp to local time
function utcToLocal(utcTimestamp) {
  return new Date(utcTimestamp * 1000);
}

// Helper: format UTC hour into local hour string
function formatHourLabel(utcHour) {
  // Convert UTC hour to local hour
  const now = new Date();
  const utcTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
  utcTime.setUTCHours(utcHour, 0, 0, 0);
  const localHour = utcTime.getHours();
  return localHour.toString().padStart(2, '0') + ':00';
}

// Helper: format UTC timestamp into local day label
function formatDayLabel(utcTimestamp) {
  const localDate = utcToLocal(utcTimestamp);
  return localDate.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit' });
}

async function reloadData(){
  const r = await fetch('/data');
  const {labels,values,hourly,daily} = await r.json();

  // Set status text
  const statusTxt = values.length
        ? (values.at(-1) ? 'ðŸŸ¢ Connection up' : 'ðŸ”´ No connection')
        : 'No data yet';
  document.getElementById('status').textContent = statusTxt;

  // Detailed timeline - convert UTC timestamps to local times
  const localLabels = labels.map(utcTimestamp => utcToLocal(utcTimestamp).toISOString());
  
  if(!chart){
    chart = new Chart(document.getElementById('c'),{
      type:'line',
      data:{labels:localLabels,
            datasets:[{label:'Online Status',data:values,stepped:true,fill:true}]},
      options:{scales:{
        y:{min:0,max:1,ticks:{stepSize:1,callback:v=>v?'Online':'Offline'}},
        x:{type:'time',time:{unit:'hour'}}
      }}
    });
  }else{
    chart.data.labels = localLabels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
  
  // 24-hour chart - convert UTC to local time
  if(hourly && hourly.length){
    if(!hourlyChart){
      hourlyChart = new Chart(document.getElementById('hourlyChart'),{
        type:'bar',
        data:{
          labels:hourly.map(h=>h.uptime<0 ? formatHourLabel(h.hour)+' ?' : formatHourLabel(h.hour)),
          datasets:[{
            label:'Hourly Status',
            data:hourly.map(h=>h.uptime<0?0.5:h.uptime),
            backgroundColor:hourly.map(h=>h.uptime<0?'#3b82f6':(h.uptime>=0.999?'#4ade80':(h.uptime>=0.98?'#eab308':'#ef4444'))),
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          scales:{
            y:{min:0,max:1,ticks:{stepSize:0.2,callback:v=>(v*100).toFixed(0)+'%'}},
            x:{title:{display:true,text:'Hour (local time)'}}
          },
          plugins:{
            tooltip:{
              callbacks:{
                label:ctx=>{
                  const hourData = hourly[ctx.dataIndex];
                  return hourData.uptime<0 ? 'No data available' : `Availability: ${(ctx.parsed.y*100).toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }else{
      hourlyChart.data.labels = hourly.map(h=>h.uptime<0 ? formatHourLabel(h.hour)+' ?' : formatHourLabel(h.hour));
      hourlyChart.data.datasets[0].data = hourly.map(h=>h.uptime<0?0.5:h.uptime);
      hourlyChart.data.datasets[0].backgroundColor = hourly.map(h=>h.uptime<0?'#3b82f6':(h.uptime>=0.999?'#4ade80':(h.uptime>=0.98?'#eab308':'#ef4444')));
      hourlyChart.update();
    }
  }
  
  // Daily chart - convert UTC to local time
  if(daily && daily.length){
    if(!dailyChart){
      dailyChart = new Chart(document.getElementById('dailyChart'),{
        type:'bar',
        data:{
          labels:daily.map(d=>d.uptime<0 ? formatDayLabel(d.date)+' ?' : formatDayLabel(d.date)),
          datasets:[{
            label:'Daily Status',
            data:daily.map(d=>d.uptime<0?0.5:d.uptime),
            backgroundColor:daily.map(d=>d.uptime<0?'#3b82f6':(d.uptime>=0.999?'#4ade80':(d.uptime>=0.98?'#eab308':'#ef4444'))),
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          scales:{
            y:{min:0,max:1,ticks:{stepSize:0.2,callback:v=>(v*100).toFixed(0)+'%'}},
            x:{title:{display:true,text:'Day (local time)'}}
          },
          plugins:{
            tooltip:{
              callbacks:{
                label:ctx=>{
                  const dayData = daily[ctx.dataIndex];
                  return dayData.uptime<0 ? 'No data available' : `Availability: ${(ctx.parsed.y*100).toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }else{
      dailyChart.data.labels = daily.map(d=>d.uptime<0 ? formatDayLabel(d.date)+' ?' : formatDayLabel(d.date));
      dailyChart.data.datasets[0].data = daily.map(d=>d.uptime<0?0.5:d.uptime);
      dailyChart.data.datasets[0].backgroundColor = daily.map(d=>d.uptime<0?'#3b82f6':(d.uptime>=0.999?'#4ade80':(d.uptime>=0.98?'#eab308':'#ef4444')));
      dailyChart.update();
    }
  }
}

reloadData();
setInterval(reloadData, 60000);   // every minute
</script></body></html>
